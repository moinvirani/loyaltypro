<!DOCTYPE html>
<html>
<head>
    <title>Apple Wallet Pass Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .pass-link { display: inline-block; padding: 10px 20px; background: #007AFF; color: white; text-decoration: none; border-radius: 5px; }
        .qr-code { margin: 10px 0; }
        .status { padding: 5px; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>Apple Wallet Pass Test</h1>
    
    <div class="test-section">
        <h2>QR Code Test</h2>
        <p>Scan this QR code with your iPhone Camera app:</p>
        <div class="qr-code">
            <canvas id="qrcode"></canvas>
        </div>
        <p>QR Code should redirect to: <a href="/wallet/28" target="_blank">/wallet/28</a></p>
    </div>
    
    <div class="test-section">
        <h2>Direct Download Test</h2>
        <p>Click this button to download the pass directly:</p>
        <a href="/api/cards/28/wallet-pass" class="pass-link">Add to Apple Wallet</a>
    </div>
    
    <div class="test-section">
        <h2>Pass Validation</h2>
        <div id="validation-results">Testing pass structure...</div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script>
        // Generate QR code
        const canvas = document.getElementById('qrcode');
        const walletUrl = window.location.origin + '/wallet/28';
        QRCode.toCanvas(canvas, walletUrl, { width: 200 }, function(error) {
            if (error) console.error(error);
        });
        
        // Test pass validation
        async function testPass() {
            const resultsDiv = document.getElementById('validation-results');
            
            try {
                const response = await fetch('/api/cards/28/wallet-pass');
                const blob = await response.blob();
                
                let status = '<div class="status ';
                if (response.ok) {
                    status += 'success">✓ Pass generated successfully<br>';
                    status += `Size: ${blob.size} bytes<br>`;
                    status += `Content-Type: ${response.headers.get('content-type')}<br>`;
                    
                    if (blob.size > 1000) {
                        status += 'Contains signature data (good for iOS compatibility)';
                    } else {
                        status += 'Warning: Small file size may indicate missing signature';
                    }
                } else {
                    status += 'error">✗ Pass generation failed<br>';
                    status += `Status: ${response.status} ${response.statusText}`;
                }
                status += '</div>';
                
                resultsDiv.innerHTML = status;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">✗ Error: ${error.message}</div>`;
            }
        }
        
        // Run test on page load
        testPass();
        
        // Refresh test every 10 seconds
        setInterval(testPass, 10000);
    </script>
</body>
</html>